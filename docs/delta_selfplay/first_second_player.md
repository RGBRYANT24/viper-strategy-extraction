# å…ˆæ‰‹/åæ‰‹è®­ç»ƒæœºåˆ¶è¯¦è§£

## é—®é¢˜ï¼šç¥ç»ç½‘ç»œå¦‚ä½•å­¦ä¹ åæ‰‹(O)æ“ä½œï¼Ÿ

**ç­”æ¡ˆ**: é€šè¿‡ **è§†è§’ç¿»è½¬ (Perspective Flipping)** æŠ€æœ¯ï¼Œè®©ç¥ç»ç½‘ç»œçœ‹åˆ°ç»Ÿä¸€çš„è¾“å…¥è¡¨ç¤ºã€‚

---

## æ ¸å¿ƒä»£ç ä½ç½®

### 1. éšæœºå†³å®šå…ˆæ‰‹/åæ‰‹ (50%æ¦‚ç‡)

ğŸ“ **æ–‡ä»¶**: `gym_env/tictactoe_delta_selfplay.py` ç¬¬114è¡Œ

```python
def reset(self, seed=None, options=None):
    # â­ å…³é”®: éšæœºå†³å®šå…ˆæ‰‹/åæ‰‹
    self.play_as_o = (np.random.random() < self.play_as_o_prob)
    #                                      ^^^^^^^^^^^^^^^^^^^
    #                                      é»˜è®¤ 0.5 = 50% åæ‰‹

    # å¦‚æœæ˜¯åæ‰‹(O)ï¼Œå¯¹æ‰‹å…ˆèµ°
    if self.play_as_o:
        opponent_action = self._opponent_move()
        self.board[opponent_action] = 1  # å¯¹æ‰‹ä¸‹X
```

### 2. è§†è§’ç¿»è½¬æœºåˆ¶ (æ ¸å¿ƒ)

ğŸ“ **æ–‡ä»¶**: `gym_env/tictactoe_delta_selfplay.py` ç¬¬182-199è¡Œ

```python
def _get_observation(self):
    """
    è·å–è§‚å¯Ÿï¼ˆä»è‡ªå·±çš„è§†è§’ï¼‰

    å…³é”®ï¼šæ— è®ºå…ˆæ‰‹åæ‰‹ï¼Œç¥ç»ç½‘ç»œè¾“å…¥å¿…é¡»ä¸€è‡´
    - è‡ªå·±çš„æ£‹å­æ€»æ˜¯è¡¨ç¤ºä¸º 1
    - å¯¹æ‰‹çš„æ£‹å­æ€»æ˜¯è¡¨ç¤ºä¸º -1
    """
    if self.play_as_o:
        # â­ åæ‰‹O: ç¿»è½¬æ£‹ç›˜è§†è§’
        # å®é™…æ£‹ç›˜: X=1, O=-1
        # ç½‘ç»œè¾“å…¥: è‡ªå·±(O)=1, å¯¹æ‰‹(X)=-1
        return -self.board.copy()  # å…³é”®ï¼šå–è´Ÿå·ï¼
    else:
        # å…ˆæ‰‹X: ç›´æ¥è¿”å›
        return self.board.copy()
```

---

## å·¥ä½œåŸç†å›¾è§£

### å…ˆæ‰‹ (X) è®­ç»ƒ

```
å®é™…æ£‹ç›˜:          ç¥ç»ç½‘ç»œè¾“å…¥:
  X | . | O          1 | 0 | -1
 -----------        -----------
  . | . | .          0 | 0 | 0
 -----------        -----------
  . | . | .          0 | 0 | 0

è‡ªå·±=X=1           è‡ªå·±=1 âœ“
å¯¹æ‰‹=O=-1          å¯¹æ‰‹=-1 âœ“
```

### åæ‰‹ (O) è®­ç»ƒ

```
å®é™…æ£‹ç›˜:          ç¥ç»ç½‘ç»œè¾“å…¥ (ç¿»è½¬å):
  X | . | O          -1 | 0 | 1
 -----------        -----------
  . | . | .          0  | 0 | 0
 -----------        -----------
  . | . | .          0  | 0 | 0

è‡ªå·±=O=-1          è‡ªå·±=1 âœ“  (âˆ’(âˆ’1)=1)
å¯¹æ‰‹=X=1           å¯¹æ‰‹=-1 âœ“  (âˆ’1=âˆ’1)
```

**å…³é”®æ´å¯Ÿ**: æ— è®ºå…ˆæ‰‹åæ‰‹ï¼Œç¥ç»ç½‘ç»œ**æ€»æ˜¯çœ‹åˆ°"è‡ªå·±=1, å¯¹æ‰‹=-1"**ï¼

---

## å®Œæ•´è®­ç»ƒæµç¨‹ç¤ºä¾‹

### Episode A: åæ‰‹è®­ç»ƒ

```python
# 1. reset()
play_as_o = True  # 50%æ¦‚ç‡

# 2. å¯¹æ‰‹(X)å…ˆèµ°ä¸­å¿ƒ
board = [0, 0, 0, 0, 1, 0, 0, 0, 0]

# 3. ç¥ç»ç½‘ç»œçœ‹åˆ° (ç¿»è½¬)
obs = -board = [0, 0, 0, 0, -1, 0, 0, 0, 0]
#                           â†‘å¯¹æ‰‹=-1

# 4. ç¥ç»ç½‘ç»œé¢„æµ‹
action = 0  # ä¸‹è§’è½

# 5. æ‰§è¡Œ (æˆ‘æ–¹O)
board[0] = -1  # [âˆ’1, 0, 0, 0, 1, ...]

# 6. ç»§ç»­å¯¹æˆ˜...
# 7. è·å¾—å¥–åŠ±ï¼Œå­¦ä¹ 
```

### Episode B: å…ˆæ‰‹è®­ç»ƒ

```python
# 1. reset()
play_as_o = False  # 50%æ¦‚ç‡

# 2. ç¥ç»ç½‘ç»œå…ˆèµ°
obs = [0, 0, 0, 0, 0, 0, 0, 0, 0]  # ä¸ç¿»è½¬

# 3. ç¥ç»ç½‘ç»œé¢„æµ‹
action = 4  # ä¸‹ä¸­å¿ƒ

# 4. æ‰§è¡Œ (æˆ‘æ–¹X)
board[4] = 1  # [0, 0, 0, 0, 1, ...]

# 5. å¯¹æ‰‹ä¸‹æ£‹...
# 6. è·å¾—å¥–åŠ±ï¼Œå­¦ä¹ 
```

---

## ä¸ºä»€ä¹ˆéœ€è¦ç¿»è½¬ï¼Ÿ

### âŒ ä¸ç¿»è½¬çš„é—®é¢˜

```python
# å…ˆæ‰‹è®­ç»ƒ
è¾“å…¥: [1, 0, -1, ...]  # è‡ªå·±X=1
å­¦åˆ°: "å½“æˆ‘=1æ—¶ï¼Œä¸‹è¿™é‡Œ"

# åæ‰‹æ¨ç† (ä¸ç¿»è½¬)
è¾“å…¥: [-1, 0, 1, ...]  # è‡ªå·±O=-1 âŒ
é—®é¢˜: ä»æœªè§è¿‡"è‡ªå·±=-1"ï¼
ç»“æœ: å®Œå…¨å¤±æ•ˆ
```

### âœ… ç¿»è½¬çš„å¥½å¤„

```python
# å…ˆæ‰‹è®­ç»ƒ
è¾“å…¥: [1, 0, -1, ...]  # è‡ªå·±=1, å¯¹æ‰‹=-1

# åæ‰‹æ¨ç† (ç¿»è½¬)
è¾“å…¥: [1, 0, -1, ...]  # ç¿»è½¬å: è‡ªå·±=1, å¯¹æ‰‹=-1 âœ“
ç»“æœ: å’Œå…ˆæ‰‹ä¸€æ ·ï¼ç”¨åŒä¸€ç­–ç•¥
```

---

## éªŒè¯ä»£ç 

```python
from gym_env.tictactoe_delta_selfplay import TicTacToeDeltaSelfPlayEnv
from gym_env.policies import RandomPlayerPolicy
from gymnasium import spaces
import numpy as np

# åˆ›å»ºç¯å¢ƒ
obs_space = spaces.Box(low=-1, high=1, shape=(9,), dtype=np.float32)
act_space = spaces.Discrete(9)
baseline_pool = [RandomPlayerPolicy(obs_space, act_space)]

env = TicTacToeDeltaSelfPlayEnv(
    baseline_pool=baseline_pool,
    play_as_o_prob=1.0  # å¼ºåˆ¶åæ‰‹
)

# æµ‹è¯•
obs, _ = env.reset(seed=42)

print(f"è§’è‰²: {'Oåæ‰‹' if env.play_as_o else 'Xå…ˆæ‰‹'}")
print(f"\nå®é™…æ£‹ç›˜:\n{env.board.reshape(3, 3)}")
print(f"\nç½‘ç»œè¾“å…¥:\n{obs.reshape(3, 3)}")

# éªŒè¯
if env.play_as_o:
    assert np.allclose(obs, -env.board)
    print("\nâœ“ ç¿»è½¬æ­£ç¡®ï¼")
```

---

## æ€»ç»“

| ç»„ä»¶ | ä»£ç ä½ç½® | ä½œç”¨ |
|------|---------|------|
| å…ˆåæ‰‹å†³å®š | `reset()` L114 | 50%æ¦‚ç‡åæ‰‹ |
| è§†è§’ç¿»è½¬ | `_get_observation()` L190-194 | åæ‰‹æ—¶å–è´Ÿ |
| æ ‡è®°å¤„ç† | `step()` L147 | æ­£ç¡®è®¾ç½®X/O |

**æ ¸å¿ƒ**: é€šè¿‡ç¿»è½¬ï¼Œç¥ç»ç½‘ç»œç”¨**ä¸€ä¸ªç­–ç•¥**åŒæ—¶å­¦ä¼šå…ˆæ‰‹å’Œåæ‰‹ï¼ğŸ¯
