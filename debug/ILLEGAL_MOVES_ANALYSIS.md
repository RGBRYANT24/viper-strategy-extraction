# 非法移动分析功能说明

## 功能概述

当运行多局对战（`n_games > 1`）且出现非法移动时，工具会自动显示 **非法移动详细分析**。

## 核心功能

### 1. 自动记录所有非法移动

每次非法移动都会记录：
- 🎮 发生在第几局游戏
- 👤 哪个玩家产生非法移动
- 📋 非法移动前的棋盘状态（原始视角）
- 🔄 转换后的输入（如果有视角转换）
- ✅ 合法动作列表
- ❌ 模型预测的非法动作
- 📍 发生在第几步

### 2. 关键分析：判断是否相同局面

**这是最重要的诊断功能！**

工具会自动分析：
- ✅ 所有非法移动是否都发生在**相同的棋盘局面**下
- ✅ 如果是，这表明问题是**系统性的、可复现的**
- ✅ 如果不是，则问题可能是**模型整体能力不足**

### 3. 按局面分组展示

将所有非法移动按棋盘局面分组，对于每个局面显示：
- 棋盘可视化（原始视角）
- 转换后的输入（如果有）
- 合法动作 vs 预测动作
- 发生在哪些游戏中

### 4. 智能诊断建议

根据分析结果提供针对性建议：
- 如果都是同一局面：重点排查该局面的处理逻辑
- 如果是多个局面：考虑增加训练数据或调整模型

---

## 使用示例

### 运行命令

```bash
# 运行10局对战
python debug/battle_detailed.py --mode nn-vs-tree --n-games 10
```

### 输出示例 - 情况1：所有非法移动都在同一局面

```
████████████████████████████████████████████████████████████████████████████████
非法移动详细分析 ILLEGAL MOVES ANALYSIS
████████████████████████████████████████████████████████████████████████████████

总计非法移动: 10 次
不同的局面数: 1

🔍 关键发现：所有非法移动都发生在 **相同的局面** 下！
   这表明模型在这个特定局面下存在系统性错误。

────────────────────────────────────────────────────────────────────────────────
非法移动局面详情:
────────────────────────────────────────────────────────────────────────────────

局面 1/1 (出现 10 次):
────────────────────────────────────
原始棋盘状态:
  . | . | .
 -----------
  . | X | .
 -----------
  . | . | .

转换后的输入（模型实际看到的）:
  . | . | .
 -----------
  . | O | .
 -----------
  . | . | .

原始棋盘数组: [ 0.  0.  0.  0.  1.  0.  0.  0.  0.]
转换后数组: [-0. -0. -0. -0. -1. -0. -0. -0. -0.]
合法动作: [0 1 2 3 5 6 7 8]
模型预测: 4
是否合法: False

发生在游戏: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

────────────────────────────────────────────────────────────────────────────────
建议:
────────────────────────────────────────────────────────────────────────────────
  ❌ 严重问题：所有非法移动都在同一局面
  📌 可能原因：
     1. 模型在训练时未见过此类局面
     2. 视角转换后的输入有问题
     3. 模型对特定棋型的处理有bug
  💡 建议：
     1. 检查上述转换后的输入是否符合预期
     2. 在训练数据中补充此类局面
     3. 使用 --epsilon 0.3 测试随机探索能否避免
================================================================================
```

**诊断结论：**
- 🎯 问题非常明确：模型总是在棋盘中心只有一个X时预测位置4（已被占用）
- 🔍 这是一个**系统性错误**，每次遇到这个局面都会犯同样的错误
- 💡 修复方向明确：检查视角转换逻辑或补充训练数据

---

### 输出示例 - 情况2：多个不同局面

```
████████████████████████████████████████████████████████████████████████████████
非法移动详细分析 ILLEGAL MOVES ANALYSIS
████████████████████████████████████████████████████████████████████████████████

总计非法移动: 15 次
不同的局面数: 5

🔍 非法移动发生在 5 个不同的局面

────────────────────────────────────────────────────────────────────────────────
非法移动局面详情:
────────────────────────────────────────────────────────────────────────────────

局面 1/5 (出现 4 次):
────────────────────────────────────
[显示第一个局面的详细信息]
发生在游戏: [2, 5, 8, 12]

局面 2/5 (出现 3 次):
────────────────────────────────────
[显示第二个局面的详细信息]
发生在游戏: [3, 7, 11]

...（其他局面）

────────────────────────────────────────────────────────────────────────────────
建议:
────────────────────────────────────────────────────────────────────────────────
  ⚠️  非法移动发生在 5 个不同局面
  📌 可能原因：
     1. 模型整体预测能力不足
     2. 训练数据不够充分
  💡 建议：
     1. 增加训练数据
     2. 调整模型参数
     3. 检查训练过程是否正常
================================================================================
```

**诊断结论：**
- 🎯 问题较分散：在多个不同局面下都会出错
- 🔍 这可能是**模型整体能力不足**的表现
- 💡 修复方向：增加训练数据、调整模型结构或训练参数

---

## 实际应用场景

### 场景1: 快速定位问题

```bash
# 运行10局快速诊断
python debug/battle_detailed.py --mode nn-vs-tree --n-games 10
```

**如果看到：**
> 🔍 关键发现：所有非法移动都发生在 **相同的局面** 下！

**立即行动：**
1. 检查该局面的视角转换是否正确
2. 查看模型是否在训练时见过类似局面
3. 尝试随机探索：`--epsilon 0.3` 看是否能避免

### 场景2: 验证修复效果

**修复前：**
```bash
python debug/battle_detailed.py --n-games 20 --seed 42
# 输出：所有20次非法移动都在同一局面
```

**修复后：**
```bash
python debug/battle_detailed.py --n-games 20 --seed 42
# 期望：非法移动次数大幅减少或完全消失
```

### 场景3: 训练数据分析

如果发现某个局面反复出现非法移动：
1. 记录该局面的详细信息
2. 检查训练数据中是否包含该局面
3. 增加该类局面的训练样本

---

## 技术细节

### 记录的信息

```python
illegal_record = {
    'game_idx': 1,                          # 第几局游戏
    'player_name': '决策树 (O)',             # 玩家名称
    'player_id': -1,                        # 玩家ID (1=X, -1=O)
    'board_before_move': [0,0,0,0,1,0,0,0,0],  # 原始棋盘
    'transformed_board': [0,0,0,0,-1,0,0,0,0], # 转换后输入
    'legal_actions': [0,1,2,3,5,6,7,8],     # 合法动作
    'predicted_action': 4,                  # 预测动作
    'had_perspective_transform': True,      # 是否转换视角
    'step': 2                               # 第几步
}
```

### 局面分组算法

```python
# 使用棋盘状态作为key进行分组
board_key = tuple(board.flatten())
board_groups[board_key].append(record)
```

### 相同局面判定

两个棋盘被认为是"相同局面"当且仅当：
- 所有9个位置的值完全相同
- 使用 `numpy.array_equal()` 比较

---

## 常见问题

### Q: 为什么要关注"是否都是同一局面"？

A: 这是诊断的关键！
- **都是同一局面** → 系统性错误，容易修复，针对性强
- **多个不同局面** → 模型整体问题，需要更全面的改进

### Q: 如果都是同一局面，如何修复？

A: 三步走：
1. 仔细检查分析报告中的"转换后数组"是否正确
2. 在训练数据中补充该局面的样本
3. 测试随机探索能否绕过该局面

### Q: 单局游戏会显示这个分析吗？

A: 不会。只有 `n_games > 1` 且存在非法移动时才显示，因为：
- 单局无法判断是否"都是同一局面"
- 分析的价值在于发现模式

---

## 与其他功能的配合

### 配合统计总结

```
对战总结 BATTLE SUMMARY
...
非法移动率: 80.0% (8/10)
...

↓ （紧接着显示）

非法移动详细分析
...
关键发现：所有非法移动都发生在相同的局面下
...
```

### 配合随机探索

```bash
# 先确定性运行，找到问题局面
python debug/battle_detailed.py --n-games 10 --epsilon 0.0

# 然后用随机探索验证能否避免
python debug/battle_detailed.py --n-games 10 --epsilon 0.3
```

---

## 总结

非法移动分析功能是一个强大的诊断工具：
- ✅ 自动记录所有非法移动的完整上下文
- ✅ 智能判断是否为系统性问题
- ✅ 按局面分组，清晰展示问题模式
- ✅ 提供针对性的修复建议

使用此功能可以**大幅缩短调试时间**，快速定位问题根源！
