# battle_detailed.py 使用指南

## 一行命令快速调试

### 🎯 最简单的用法
```bash
cd /path/to/viper-verifiable-rl-impl
python debug/battle_detailed.py
```
默认运行：神经网络 vs 决策树，1局，无随机探索

---

## 🚀 常用命令速查

### 调试非法移动问题
```bash
# 神经网络先手 vs 决策树后手
python debug/battle_detailed.py --mode nn-vs-tree

# 决策树先手 vs 神经网络后手
python debug/battle_detailed.py --mode tree-vs-nn

# 两种情况都测试
python debug/battle_detailed.py --mode both
```

### 验证确定性（是否每次都一样）
```bash
# 使用固定种子运行3次，应该得到相同结果
python debug/battle_detailed.py --seed 42
python debug/battle_detailed.py --seed 42
python debug/battle_detailed.py --seed 42
```

### 测试随机探索（多局自动统计）
```bash
# 10%随机，运行5局（自动显示统计总结）
python debug/battle_detailed.py --n-games 5 --epsilon 0.1

# 30%随机，运行10局（自动显示统计总结）
python debug/battle_detailed.py --n-games 10 --epsilon 0.3

# 100局批量测试
python debug/battle_detailed.py --n-games 100 --epsilon 0.2
```

---

## 📋 参数快查表

| 参数 | 简写 | 默认值 | 说明 | 常用值 |
|------|------|--------|------|--------|
| `--mode` | - | `nn-vs-tree` | 对战模式 | `both` |
| `--n-games` | - | `1` | 对战局数 | `1`, `5`, `10` |
| `--epsilon` | - | `0.0` | 随机概率 | `0.0`, `0.1`, `0.3` |
| `--seed` | - | `None` | 随机种子 | `42`, `123` |

---

## 💡 典型调试流程

### Step 1: 看第一局发生了什么
```bash
python debug/battle_detailed.py --mode nn-vs-tree --n-games 1
```
👉 查看输出，找到非法移动发生在哪一步

### Step 2: 验证是否每次都一样
```bash
python debug/battle_detailed.py --mode nn-vs-tree --seed 42
python debug/battle_detailed.py --mode nn-vs-tree --seed 42
```
👉 如果两次输出完全相同，说明是确定性问题

### Step 3: 测试随机性能否避免
```bash
python debug/battle_detailed.py --mode nn-vs-tree --n-games 10 --epsilon 0.2
```
👉 统计10局中非法移动发生的次数

### Step 4: 对比先后手表现
```bash
python debug/battle_detailed.py --mode both --n-games 1
```
👉 查看同一个模型作为先手和后手的区别

---

## 🔍 输出解读

### 关键信息位置

```
当前玩家: 决策树 (O) (player_id=-1)
当前棋盘数组: [ 0.  0.  0.  0.  1.  0.  0.  0.  0.]
合法动作: [0 1 2 3 5 6 7 8]               ← 看这里：哪些位置可以下
视角转换: YES (因为是O玩家)                ← 看这里：是否转换了视角
转换后数组: [-0. -0. -0. -0. -1. -0. -0. -0. -0.]  ← 看这里：模型实际看到的输入
[决策树] 预测动作: 4                      ← 看这里：模型预测的动作
动作 4 是否合法: False                    ← 看这里：是否合法
```

### 非法移动的标志
```
⚠️  非法移动！位置 4 已被占用或超出范围
```

### 多局统计总结（n_games > 1时自动显示）

**基本统计：**
```
████████████████████████████████████████████████████████████████████████████████
对战总结 BATTLE SUMMARY
████████████████████████████████████████████████████████████████████████████████

对阵: 神经网络 (X 先手) vs 决策树 (O 后手)
总局数: 10

────────────────────────────────────────────────────────────────────────────────
胜负统计:
────────────────────────────────────────────────────────────────────────────────
  神经网络 (X) 获胜:   8 局  ( 80.0%)
  决策树 (O) 获胜:   0 局  (  0.0%)
  平局:                2 局  ( 20.0%)

────────────────────────────────────────────────────────────────────────────────
非法移动统计:
────────────────────────────────────────────────────────────────────────────────
  总计: 8 次
  神经网络 非法移动:   0 次
  决策树 非法移动:   8 次

────────────────────────────────────────────────────────────────────────────────
分析:
────────────────────────────────────────────────────────────────────────────────
  ⚠️  非法移动率: 80.0% (8/10)
  ⚠️  决策树 存在非法移动问题
  ❌ 严重问题：超过50%的对局出现非法移动
     建议：检查视角转换逻辑和模型训练数据
  ⚠️  神经网络 压倒性优势，可能存在问题
================================================================================
```

**非法移动详细分析（有非法移动时自动显示）：**
```
████████████████████████████████████████████████████████████████████████████████
非法移动详细分析 ILLEGAL MOVES ANALYSIS
████████████████████████████████████████████████████████████████████████████████

总计非法移动: 8 次
不同的局面数: 1

🔍 关键发现：所有非法移动都发生在 **相同的局面** 下！
   这表明模型在这个特定局面下存在系统性错误。

────────────────────────────────────────────────────────────────────────────────
非法移动局面详情:
────────────────────────────────────────────────────────────────────────────────

局面 1/1 (出现 8 次):
────────────────────────────────────
原始棋盘状态:
  . | . | .
 -----------
  . | X | .
 -----------
  . | . | .

转换后的输入（模型实际看到的）:
  . | . | .
 -----------
  . | O | .
 -----------
  . | . | .

原始棋盘数组: [ 0.  0.  0.  0.  1.  0.  0.  0.  0.]
转换后数组: [-0. -0. -0. -0. -1. -0. -0. -0. -0.]
合法动作: [0 1 2 3 5 6 7 8]
模型预测: 4
是否合法: False

发生在游戏: [1, 2, 3, 4, 5, 6, 7, 8]

────────────────────────────────────────────────────────────────────────────────
建议:
────────────────────────────────────────────────────────────────────────────────
  ❌ 严重问题：所有非法移动都在同一局面
  📌 可能原因：
     1. 模型在训练时未见过此类局面
     2. 视角转换后的输入有问题
     3. 模型对特定棋型的处理有bug
  💡 建议：
     1. 检查上述转换后的输入是否符合预期
     2. 在训练数据中补充此类局面
     3. 使用 --epsilon 0.3 测试随机探索能否避免
================================================================================
```

---

## 📊 保存输出到文件

```bash
# 保存到文件
python debug/battle_detailed.py --mode both --n-games 5 > debug_output.log 2>&1

# 查看文件
less debug_output.log

# 搜索非法移动
grep "非法移动" debug_output.log
```

---

## ⚠️ 常见问题

### Q: 运行时找不到模型文件？
```bash
# 指定完整路径
python debug/battle_detailed.py \
  --oracle-path log/oracle_TicTacToe-v0.zip \
  --viper-path log/viper_TicTacToe-v0_all-leaves_10.joblib
```

### Q: 想看更多局数的统计？
```bash
# 运行100局（输出会很长）
python debug/battle_detailed.py --n-games 100 --epsilon 0.1 > stats.log
grep "非法移动" stats.log | wc -l  # 统计非法移动次数
```

### Q: 如何验证视角转换是否正确？
```bash
# 运行一局，查看"转换后数组"这一行
python debug/battle_detailed.py --mode tree-vs-nn --n-games 1 | grep -A2 "视角转换"
```

---

## 🆘 需要帮助？

- 详细文档: `debug/README.md`
- 代码注释: `debug/battle_detailed.py` 顶部
- 查看帮助: `python debug/battle_detailed.py --help`
